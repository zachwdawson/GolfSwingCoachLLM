name: Deploy to AWS

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name'
        required: false
        default: 'golf-coach'
        type: string
      environment:
        description: 'Environment (dev, prod)'
        required: false
        default: 'dev'
        type: string

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  PROJECT_NAME: ${{ github.event.inputs.project_name || 'golf-coach' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  deploy:
    name: Build, Push, and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get AWS account ID
        id: get-account-id
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$AWS_ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "AWS Account ID: $AWS_ACCOUNT_ID"

      - name: Set ECR repository URLs
        id: set-ecr-urls
        run: |
          ECR_BACKEND_URL="${{ steps.get-account-id.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.PROJECT_NAME }}-backend"
          ECR_FRONTEND_URL="${{ steps.get-account-id.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.PROJECT_NAME }}-frontend"
          echo "backend_url=$ECR_BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$ECR_FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "Backend ECR URL: $ECR_BACKEND_URL"
          echo "Frontend ECR URL: $ECR_FRONTEND_URL"

      - name: Build and push backend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_BACKEND_REPOSITORY: ${{ env.PROJECT_NAME }}-backend
          IMAGE_TAG: latest
        run: |
          echo "Building backend Docker image..."
          cd backend
          docker build -t $ECR_REGISTRY/$ECR_BACKEND_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_BACKEND_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_BACKEND_REPOSITORY:$IMAGE_TAG
          echo "Pushing backend image to ECR..."
          docker push $ECR_REGISTRY/$ECR_BACKEND_REPOSITORY:$IMAGE_TAG
          echo "âœ“ Backend image pushed successfully"

      - name: Build and push frontend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_FRONTEND_REPOSITORY: ${{ env.PROJECT_NAME }}-frontend
          IMAGE_TAG: latest
        run: |
          echo "Building frontend Docker image..."
          cd frontend
          docker build -f Dockerfile.prod -t $ECR_REGISTRY/$ECR_FRONTEND_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_FRONTEND_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_FRONTEND_REPOSITORY:$IMAGE_TAG
          echo "Pushing frontend image to ECR..."
          docker push $ECR_REGISTRY/$ECR_FRONTEND_REPOSITORY:$IMAGE_TAG
          echo "âœ“ Frontend image pushed successfully"

      - name: Create or update AWS Secrets Manager secrets
        id: create-secrets
        env:
          AWS_ACCESS_KEY_ID_VALUE: ${{ secrets.AWS_ACCESS_KEY_ID_VALUE || secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY_VALUE: ${{ secrets.AWS_SECRET_ACCESS_KEY_VALUE || secrets.AWS_SECRET_ACCESS_KEY }}
          OPENAI_API_KEY_VALUE: ${{ secrets.OPENAI_API_KEY_VALUE }}
        run: |
          SECRET_PREFIX="${{ env.PROJECT_NAME }}"
          
          # Create or update AWS Access Key ID secret
          if [ -n "$AWS_ACCESS_KEY_ID_VALUE" ]; then
            SECRET_NAME="${SECRET_PREFIX}/aws-access-key-id"
            if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
              echo "Updating existing secret: $SECRET_NAME"
              aws secretsmanager put-secret-value \
                --secret-id "$SECRET_NAME" \
                --secret-string "$AWS_ACCESS_KEY_ID_VALUE" \
                --region ${{ env.AWS_REGION }} >/dev/null
            else
              echo "Creating new secret: $SECRET_NAME"
              aws secretsmanager create-secret \
                --name "$SECRET_NAME" \
                --secret-string "$AWS_ACCESS_KEY_ID_VALUE" \
                --region ${{ env.AWS_REGION }} >/dev/null
            fi
            AWS_ACCESS_KEY_ID_ARN=$(aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} --query 'ARN' --output text)
            echo "aws_access_key_id_arn=$AWS_ACCESS_KEY_ID_ARN" >> $GITHUB_OUTPUT
            echo "âœ“ AWS Access Key ID secret ARN: $AWS_ACCESS_KEY_ID_ARN"
          else
            echo "âš  AWS_ACCESS_KEY_ID_VALUE not provided, skipping..."
          fi
          
          # Create or update AWS Secret Access Key secret
          if [ -n "$AWS_SECRET_ACCESS_KEY_VALUE" ]; then
            SECRET_NAME="${SECRET_PREFIX}/aws-secret-access-key"
            if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
              echo "Updating existing secret: $SECRET_NAME"
              aws secretsmanager put-secret-value \
                --secret-id "$SECRET_NAME" \
                --secret-string "$AWS_SECRET_ACCESS_KEY_VALUE" \
                --region ${{ env.AWS_REGION }} >/dev/null
            else
              echo "Creating new secret: $SECRET_NAME"
              aws secretsmanager create-secret \
                --name "$SECRET_NAME" \
                --secret-string "$AWS_SECRET_ACCESS_KEY_VALUE" \
                --region ${{ env.AWS_REGION }} >/dev/null
            fi
            AWS_SECRET_ACCESS_KEY_ARN=$(aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} --query 'ARN' --output text)
            echo "aws_secret_access_key_arn=$AWS_SECRET_ACCESS_KEY_ARN" >> $GITHUB_OUTPUT
            echo "âœ“ AWS Secret Access Key secret ARN: $AWS_SECRET_ACCESS_KEY_ARN"
          else
            echo "âš  AWS_SECRET_ACCESS_KEY_VALUE not provided, skipping..."
          fi
          
          # Create or update OpenAI API Key secret
          if [ -n "$OPENAI_API_KEY_VALUE" ]; then
            SECRET_NAME="${SECRET_PREFIX}/openai-api-key"
            if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
              echo "Updating existing secret: $SECRET_NAME"
              aws secretsmanager put-secret-value \
                --secret-id "$SECRET_NAME" \
                --secret-string "$OPENAI_API_KEY_VALUE" \
                --region ${{ env.AWS_REGION }} >/dev/null
            else
              echo "Creating new secret: $SECRET_NAME"
              aws secretsmanager create-secret \
                --name "$SECRET_NAME" \
                --secret-string "$OPENAI_API_KEY_VALUE" \
                --region ${{ env.AWS_REGION }} >/dev/null
            fi
            OPENAI_API_KEY_ARN=$(aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} --query 'ARN' --output text)
            echo "openai_api_key_arn=$OPENAI_API_KEY_ARN" >> $GITHUB_OUTPUT
            echo "âœ“ OpenAI API Key secret ARN: $OPENAI_API_KEY_ARN"
          else
            echo "âš  OPENAI_API_KEY_VALUE not provided, skipping..."
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Terraform Init
        working-directory: infra
        env:
          TF_VAR_db_username: ${{ secrets.TF_VAR_db_username }}
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
          TF_VAR_aws_access_key_id_secret_arn: ${{ steps.create-secrets.outputs.aws_access_key_id_arn }}
          TF_VAR_aws_secret_access_key_secret_arn: ${{ steps.create-secrets.outputs.aws_secret_access_key_arn }}
          TF_VAR_openai_api_key_secret_arn: ${{ steps.create-secrets.outputs.openai_api_key_arn }}
        run: |
          echo "Initializing Terraform..."
          terraform init
          echo "âœ“ Terraform initialized"

      - name: Terraform Apply
        working-directory: infra
        env:
          TF_VAR_db_username: ${{ secrets.TF_VAR_db_username }}
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
          TF_VAR_aws_access_key_id_secret_arn: ${{ steps.create-secrets.outputs.aws_access_key_id_arn }}
          TF_VAR_aws_secret_access_key_secret_arn: ${{ steps.create-secrets.outputs.aws_secret_access_key_arn }}
          TF_VAR_openai_api_key_secret_arn: ${{ steps.create-secrets.outputs.openai_api_key_arn }}
        run: |
          echo "Applying Terraform configuration..."
          terraform apply -auto-approve
          echo "âœ“ Terraform apply completed"

      - name: Get ECS cluster and service names
        id: get-ecs-info
        run: |
          CLUSTER_NAME="${{ env.PROJECT_NAME }}-cluster-${{ env.ENVIRONMENT }}"
          BACKEND_SERVICE="${{ env.PROJECT_NAME }}-backend-${{ env.ENVIRONMENT }}"
          FRONTEND_SERVICE="${{ env.PROJECT_NAME }}-frontend-${{ env.ENVIRONMENT }}"
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "backend_service=$BACKEND_SERVICE" >> $GITHUB_OUTPUT
          echo "frontend_service=$FRONTEND_SERVICE" >> $GITHUB_OUTPUT
          echo "Cluster: $CLUSTER_NAME"
          echo "Backend Service: $BACKEND_SERVICE"
          echo "Frontend Service: $FRONTEND_SERVICE"

      - name: Force ECS backend service update
        run: |
          echo "Forcing new deployment of backend service..."
          aws ecs update-service \
            --cluster ${{ steps.get-ecs-info.outputs.cluster_name }} \
            --service ${{ steps.get-ecs-info.outputs.backend_service }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}
          echo "âœ“ Backend service update initiated"

      - name: Force ECS frontend service update
        run: |
          echo "Forcing new deployment of frontend service..."
          aws ecs update-service \
            --cluster ${{ steps.get-ecs-info.outputs.cluster_name }} \
            --service ${{ steps.get-ecs-info.outputs.frontend_service }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}
          echo "âœ“ Frontend service update initiated"

      - name: Wait for backend service to stabilize
        run: |
          echo "Waiting for backend service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ steps.get-ecs-info.outputs.cluster_name }} \
            --services ${{ steps.get-ecs-info.outputs.backend_service }} \
            --region ${{ env.AWS_REGION }}
          echo "âœ“ Backend service is stable"

      - name: Wait for frontend service to stabilize
        run: |
          echo "Waiting for frontend service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ steps.get-ecs-info.outputs.cluster_name }} \
            --services ${{ steps.get-ecs-info.outputs.frontend_service }} \
            --region ${{ env.AWS_REGION }}
          echo "âœ“ Frontend service is stable"

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images pushed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ steps.set-ecr-urls.outputs.backend_url }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ steps.set-ecr-urls.outputs.frontend_url }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services updated:**" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ steps.get-ecs-info.outputs.backend_service }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ steps.get-ecs-info.outputs.frontend_service }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** \`${{ steps.get-ecs-info.outputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY

